#!/bin/bash

set -o errexit

PRJ=$1
IMG=$2 # image (registry/image@sha:*** or ar/registry/image@sha:***)
REP=$3  # target path for the report

# check required input parameters
[ -z "$PRJ" ] && echo "arg PRJ not set\n" && exit 1
[ -z "$IMG" ] && echo "arg IMG not set\n" && exit 1
[ -z "$REP" ] && echo "arg REP not set\n" && exit 1

# parse registry from image 
REG=$(echo $IMG | cut -d'/' -f 1)

# print run variables 
echo "
PRJ: $PRJ
REG: $REG
IMG: $IMG
REP: $REP
"

# confgure gcloud 
gcloud auth configure-docker $REG --quiet
gcloud config set project $PRJ --quiet

trivy image \
    --security-checks vuln \
    --no-progress \
    --timeout 10m \
    --format json \
    --output $REP \
    $IMG
