#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"

set -o errexit
set -o pipefail

# cloud run 
gcloud run deploy $ROOT_NAME \
	--allow-unauthenticated \
	--image $IMAGE_URI \
	--platform managed \
	--timeout 15m \
	--region $REGION \
	--service-account $SA_EMAIL

gcloud run services add-iam-policy-binding $ROOT_NAME \
	--member "serviceAccount:${SA_EMAIL}" \
	--region $REGION \
	--role=roles/run.invoker

SERVICE_URL=$(gcloud run services describe $ROOT_NAME \
  --region $REGION --format="value(status.url)")

echo $SERVICE_URL

# pubsub
gcloud pubsub topics create gcr

gcloud projects add-iam-policy-binding $PROJECT_ID \
     --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-pubsub.iam.gserviceaccount.com" \
     --role=roles/iam.serviceAccountTokenCreator

gcloud pubsub subscriptions create gcr-sub \
  --topic gcr \
  --ack-deadline 600 \
  --push-endpoint "${SERVICE_URL}/" \
  --push-auth-service-account $SA_EMAIL
